# ─────────────────────────────────────────────────────────────────────
# Jules Translation Sync
# ─────────────────────────────────────────────────────────────────────
# When English source docs change on main, create a Jules session that
# translates all affected pages into every supported locale and opens
# one mega-PR with the results.
#
# To add or remove a locale, edit SUPPORTED_LANGS below (one-line change).
#
# Required secrets: JULES_API_KEY
# ─────────────────────────────────────────────────────────────────────
name: Jules Translation Sync

on:
  push:
    branches: [main]
    paths:
      - "docs/content/**"
  workflow_dispatch:

permissions:
  contents: read
  actions: read

concurrency:
  group: jules-translation-sync
  cancel-in-progress: false

env:
  # ── One-line locale config ────────────────────────────────────────
  # Comma-separated ISO 639-1 codes matching the .<lang>.mdx convention.
  SUPPORTED_LANGS: "zh,es,ja"
  # ──────────────────────────────────────────────────────────────────
  JULES_API_BASE: "https://jules.googleapis.com/v1alpha"
  CHANGED_DOCS_FILE: "changed_english_docs.txt"
  MAX_POLL_ATTEMPTS: 60
  POLL_INTERVAL_SECONDS: 30
  MAX_RETRIES: 3

jobs:
  sync-translations:
    name: Sync translated docs via Jules
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      # ── 1. Checkout ───────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ── 2. Find last successful sync commit ──────────────────────
      - name: Find last successful sync commit
        id: last-success
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          LAST_SHA=$(gh api \
            "repos/${{ github.repository }}/actions/workflows/jules-sync-translations.yml/runs?status=success&branch=main&per_page=1&exclude_pull_requests=true" \
            --jq '.workflow_runs[0].head_sha // empty' 2>/dev/null || true)

          if [[ -n "$LAST_SHA" ]] && git cat-file -e "${LAST_SHA}^{commit}" 2>/dev/null; then
            echo "last_sha=${LAST_SHA}" >> "$GITHUB_OUTPUT"
            echo "Found last successful sync at ${LAST_SHA}"
          else
            echo "last_sha=" >> "$GITHUB_OUTPUT"
            echo "No previous successful run found — will diff against parent"
          fi

      # ── 3. Detect changed English source docs ─────────────────────
      - name: Detect changed English source docs
        id: detect
        env:
          LAST_SUCCESS_SHA: ${{ steps.last-success.outputs.last_sha }}
        run: |
          set -euo pipefail

          BEFORE="$LAST_SUCCESS_SHA"
          SHA="${{ github.sha }}"

          echo "::group::Diff range"
          echo "before=${BEFORE}"
          echo "sha=${SHA}"

          if [[ -z "$BEFORE" ]] || ! git cat-file -e "${BEFORE}^{commit}" 2>/dev/null; then
            echo "No prior successful run — diffing against parent commit"
            if git rev-parse --verify "${SHA}^" >/dev/null 2>&1; then
              CHANGED=$(git diff --name-only "${SHA}^" "$SHA" -- docs/content/ || true)
            else
              CHANGED=$(git ls-tree -r --name-only "$SHA" -- docs/content/ || true)
            fi
          else
            CHANGED=$(git diff --name-only "$BEFORE" "$SHA" -- docs/content/ || true)
          fi

          echo "::endgroup::"

          IFS=',' read -ra LANGS <<< "$SUPPORTED_LANGS"
          ENGLISH_FILES=()

          while IFS= read -r file; do
            [[ -z "$file" ]] && continue
            [[ "$file" != *.mdx ]] && [[ "$file" != */meta.json ]] && continue

            is_translation=false
            for lang in "${LANGS[@]}"; do
              lang="${lang//[[:space:]]/}"
              if [[ -z "$lang" ]]; then
                continue
              fi

              if [[ "$file" == *".${lang}.mdx" ]] || [[ "$file" == */meta.${lang}.json ]]; then
                is_translation=true
                break
              fi
            done

            if [[ "$is_translation" == "false" ]]; then
              ENGLISH_FILES+=("$file")
            fi
          done <<< "$CHANGED"

          if [[ ${#ENGLISH_FILES[@]} -eq 0 ]]; then
            echo "No English source doc changes found — nothing to translate."
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          printf '%s\n' "${ENGLISH_FILES[@]}" > "${RUNNER_TEMP}/${CHANGED_DOCS_FILE}"

          echo "has_changes=true" >> "$GITHUB_OUTPUT"
          echo "file_count=${#ENGLISH_FILES[@]}" >> "$GITHUB_OUTPUT"

          echo "::group::Changed English docs (${#ENGLISH_FILES[@]} files)"
          cat "${RUNNER_TEMP}/${CHANGED_DOCS_FILE}"
          echo "::endgroup::"

      # ── 4. Create Jules translation session ───────────────────────
      - name: Create Jules translation session
        if: steps.detect.outputs.has_changes == 'true'
        id: jules-create
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          set -euo pipefail

          if [[ -z "${JULES_API_KEY:-}" ]]; then
            echo "::error::JULES_API_KEY is not configured. Add it in repository Actions secrets."
            exit 1
          fi

          REPO="${{ github.repository }}"
          OWNER="${REPO%%/*}"
          REPO_NAME="${REPO##*/}"
          SOURCE="sources/github/${OWNER}/${REPO_NAME}"

          LANGS_DISPLAY=$(echo "$SUPPORTED_LANGS" | tr ',' ', ')
          FILE_LIST=$(cat "${RUNNER_TEMP}/${CHANGED_DOCS_FILE}")

          PROMPT="IMPORTANT: Before you begin, read the file docs/translation-guide.md in this repository.

          You are a professional technical translator working on the Tauri Template documentation.

          The following English source documentation files have changed and need their translations updated:
          ${FILE_LIST}

          For each file listed above, update (or create if missing) the translation files for these locales: ${LANGS_DISPLAY}.

          Translation file naming convention:
          - English source:  docs/content/docs/<name>.mdx
          - Translation:     docs/content/docs/<name>.<lang>.mdx
          - Section meta:    docs/content/docs/meta.json -> docs/content/docs/meta.<lang>.json

          STRICT RULES (violations will cause the PR to be rejected):
          1. Read docs/translation-guide.md FIRST and follow every rule in it.
          2. Preserve ALL Markdown / MDX structure exactly: headings, tables, code blocks, admonitions, frontmatter keys, and JSX components.
          3. NEVER translate: CLI commands, code snippets, fenced code blocks, API endpoints, environment variable names, file paths, URLs, configuration keys, CSS class names.
          4. NEVER translate terms listed in the glossary of docs/translation-guide.md.
          5. Preserve ALL anchor IDs, link targets, and href values verbatim.
          6. If content was removed in the English source, remove it from every translation too.
          7. If a translation file is missing, create it from scratch by translating the English source.
          8. NEVER modify English source files (.mdx files without a language suffix).
          9. NEVER modify any files outside docs/content/.
          10. For meta.json files: create/update meta.<lang>.json; translate 'title' values but keep 'pages' array values unchanged.

          Open a single PR titled: docs(i18n): sync translations for updated English docs"

          TITLE="docs(i18n): sync translations for updated English docs"

          BODY=$(jq -n \
            --arg prompt "$PROMPT" \
            --arg title "$TITLE" \
            --arg source "$SOURCE" \
            '{
              prompt: $prompt,
              title: $title,
              automationMode: "AUTO_CREATE_PR",
              sourceContext: {
                source: $source,
                githubRepoContext: {
                  startingBranch: "main"
                }
              }
            }')

          SESSION_NAME=""
          for attempt in $(seq 1 "$MAX_RETRIES"); do
            HTTP_CODE=$(curl -s -o /tmp/jules_response.json -w "%{http_code}" \
              -X POST \
              -H "Content-Type: application/json" \
              -H "X-Goog-Api-Key: ${JULES_API_KEY}" \
              -d "$BODY" \
              "${JULES_API_BASE}/sessions")

            if [[ "$HTTP_CODE" == "200" ]]; then
              SESSION_NAME=$(jq -r '.name' /tmp/jules_response.json)
              echo "Jules session created: ${SESSION_NAME}"
              break
            fi

            echo "::warning::Jules API returned HTTP ${HTTP_CODE} (attempt ${attempt}/${MAX_RETRIES})"
            cat /tmp/jules_response.json || true

            if [[ "$attempt" -lt "$MAX_RETRIES" ]]; then
              SLEEP_SECS=$(( 2 ** attempt ))
              echo "Retrying in ${SLEEP_SECS}s..."
              sleep "$SLEEP_SECS"
            else
              echo "::error::Jules session creation failed after ${MAX_RETRIES} attempts (HTTP ${HTTP_CODE})"
              exit 1
            fi
          done

          echo "session_name=${SESSION_NAME}" >> "$GITHUB_OUTPUT"

      # ── 5. Poll until Jules finishes ──────────────────────────────
      - name: Poll Jules session until completion
        if: steps.detect.outputs.has_changes == 'true'
        id: jules-poll
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          JULES_SESSION_NAME: ${{ steps.jules-create.outputs.session_name }}
        run: |
          set -euo pipefail

          echo "Polling session: ${JULES_SESSION_NAME}"
          echo "Max attempts: ${MAX_POLL_ATTEMPTS} × ${POLL_INTERVAL_SECONDS}s = $(( MAX_POLL_ATTEMPTS * POLL_INTERVAL_SECONDS / 60 )) min"

          JULES_STATE=""
          PR_URL=""
          PR_TITLE=""

          for attempt in $(seq 1 "$MAX_POLL_ATTEMPTS"); do
            HTTP_CODE=$(curl -s -o /tmp/jules_poll.json -w "%{http_code}" \
              -H "X-Goog-Api-Key: ${JULES_API_KEY}" \
              "${JULES_API_BASE}/${JULES_SESSION_NAME}")

            if [[ "$HTTP_CODE" != "200" ]]; then
              echo "::warning::Poll returned HTTP ${HTTP_CODE} (attempt ${attempt})"
              sleep "$POLL_INTERVAL_SECONDS"
              continue
            fi

            JULES_STATE=$(jq -r '.state // "UNKNOWN"' /tmp/jules_poll.json)
            echo "[${attempt}/${MAX_POLL_ATTEMPTS}] State: ${JULES_STATE}"

            case "$JULES_STATE" in
              COMPLETED)
                PR_URL=$(jq -r '.result.pullRequestUrl // empty' /tmp/jules_poll.json)
                PR_TITLE=$(jq -r '.result.pullRequestTitle // empty' /tmp/jules_poll.json)
                echo "Jules session completed successfully."
                echo "PR URL: ${PR_URL}"
                break
                ;;
              FAILED|ERROR)
                echo "::error::Jules session ended with state: ${JULES_STATE}"
                jq '.' /tmp/jules_poll.json || true
                exit 1
                ;;
              *)
                # Still running — wait and retry
                sleep "$POLL_INTERVAL_SECONDS"
                ;;
            esac
          done

          if [[ "$JULES_STATE" != "COMPLETED" ]]; then
            echo "::error::Timed out after ${MAX_POLL_ATTEMPTS} poll attempts. Last state: ${JULES_STATE}"
            exit 1
          fi

          echo "jules_state=${JULES_STATE}" >> "$GITHUB_OUTPUT"
          echo "pr_url=${PR_URL}" >> "$GITHUB_OUTPUT"
          echo "pr_title=${PR_TITLE}" >> "$GITHUB_OUTPUT"

      # ── 6. Summary ────────────────────────────────────────────────
      - name: Write job summary
        if: always()
        env:
          HAS_CHANGES: ${{ steps.detect.outputs.has_changes }}
          FILE_COUNT: ${{ steps.detect.outputs.file_count }}
          JULES_STATE: ${{ steps.jules-poll.outputs.jules_state }}
          PR_URL: ${{ steps.jules-poll.outputs.pr_url }}
          PR_TITLE: ${{ steps.jules-poll.outputs.pr_title }}
        run: |
          {
            echo "## Jules Translation Sync"
            echo ""
            if [[ "${HAS_CHANGES}" != "true" ]]; then
              echo "No English source doc changes detected — nothing to translate."
            else
              echo "**Files processed:** ${FILE_COUNT}"
              echo ""
              if [[ -n "${JULES_STATE}" ]]; then
                echo "**Jules state:** \`${JULES_STATE}\`"
              fi
              if [[ -n "${PR_URL}" ]]; then
                echo ""
                echo "**Translation PR:** [${PR_TITLE}](${PR_URL})"
              fi
            fi
          } >> "$GITHUB_STEP_SUMMARY"
